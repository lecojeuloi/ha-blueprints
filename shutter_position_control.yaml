blueprint:
  name: Shutter Multi-Phase Control
  description: >
    EN: Multi-phase shutter control (pre-open, open, pre-close, close) with
    from/to positions, tolerances, randomization and notifications.

    FR: Contrôle multi-phase des volets (pré-ouverture, ouverture, pré-fermeture,
    fermeture) avec positions from/to, tolérances, randomisation et notifications.
  domain: automation

input:

  ############################################################
  # GLOBAL
  ############################################################
  global_phase_prefix:
    name: "Préfixe global / Global prefix"
    description: >
      EN: Optional text prefix used in notifications (e.g.: 'Extensions étage').

      FR: Texte optionnel utilisé en préfixe dans les notifications
      (ex : 'Extensions étage').
    default: ""
    selector:
      text: {}

  ############################################################
  # PRE-OPEN PHASE
  ############################################################
  pre_open_enabled:
    name: "Activer la phase pré-ouverture / Enable pre-open phase"
    default: false
    selector:
      boolean: {}

  pre_open_covers:
    name: "Volets pré-ouverture / Pre-open covers"
    selector:
      entity:
        domain: cover
        multiple: true

  pre_open_use_from:
    name: "Filtrer par position de départ ? / Use from position filter?"
    description: >
      EN: If enabled, only shutters within [from ± tolerance] will move.

      FR: Si activé, seuls les volets dans [from ± tolérance] bougeront.
    default: false
    selector:
      boolean: {}

  pre_open_from:
    name: "Pré-ouverture - From (%) – position de départ"
    default: 0
    selector:
      number:
        min: 0
        max: 100
        unit_of_measurement: "%"

  pre_open_from_tolerance:
    name: "Pré-ouverture - Tolérance from (%)"
    default: 0
    selector:
      number:
        min: 0
        max: 20
        unit_of_measurement: "%"

  pre_open_to:
    name: "Pré-ouverture - To (%) – position cible"
    default: 40
    selector:
      number:
        min: 0
        max: 100
        unit_of_measurement: "%"

  pre_open_use_to_random:
    name: "Pré-ouverture - Randomiser la position cible ?"
    default: false
    selector:
      boolean: {}

  pre_open_to_tolerance:
    name: "Pré-ouverture - Tolérance cible (%)"
    default: 0
    selector:
      number:
        min: 0
        max: 20
        unit_of_measurement: "%"

  pre_open_time:
    name: "Pré-ouverture - Heure de déclenchement / Trigger time"
    selector:
      time: {}

  pre_open_time_random_minutes:
    name: "Pré-ouverture - Tolérance d’heure (min) / Time tolerance (min)"
    default: 0
    selector:
      number:
        min: 0
        max: 60
        unit_of_measurement: "min"

  pre_open_weekdays:
    name: "Pré-ouverture - Jours d’exécution / Weekdays"
    default:
      - mon
      - tue
      - wed
      - thu
      - fri
    selector:
      select:
        multiple: true
        options:
          - mon
          - tue
          - wed
          - thu
          - fri
          - sat
          - sun

  pre_open_notify_devices:
    name: "Pré-ouverture - Appareils de notification / Notification devices"
    default: []
    selector:
      device:
        multiple: true
        integration: mobile_app

  pre_open_notify_title:
    name: "Pré-ouverture - Titre notification / Notification title"
    default: "Volets – Pré-ouverture"
    selector:
      text: {}

  pre_open_notify_message:
    name: "Pré-ouverture - Message notification (préfixe optionnel)"
    description: >
      EN: Optional static prefix text for the notification message.

      FR: Texte de préfixe optionnel pour le message de notification.
    default: ""
    selector:
      text:
        multiline: true

  ############################################################
  # OPEN PHASE
  ############################################################
  open_enabled:
    name: "Activer la phase d’ouverture / Enable open phase"
    default: false
    selector:
      boolean: {}

  open_covers:
    name: "Volets ouverture / Open covers"
    selector:
      entity:
        domain: cover
        multiple: true

  open_use_from:
    name: "Ouverture - Filtrer par position de départ ?"
    default: false
    selector:
      boolean: {}

  open_from:
    name: "Ouverture - From (%) – position de départ"
    default: 40
    selector:
      number:
        min: 0
        max: 100
        unit_of_measurement: "%"

  open_from_tolerance:
    name: "Ouverture - Tolérance from (%)"
    default: 0
    selector:
      number:
        min: 0
        max: 20
        unit_of_measurement: "%"

  open_to:
    name: "Ouverture - To (%) – position cible"
    default: 100
    selector:
      number:
        min: 0
        max: 100
        unit_of_measurement: "%"

  open_use_to_random:
    name: "Ouverture - Randomiser la position cible ?"
    default: false
    selector:
      boolean: {}

  open_to_tolerance:
    name: "Ouverture - Tolérance cible (%)"
    default: 0
    selector:
      number:
        min: 0
        max: 20
        unit_of_measurement: "%"

  open_time:
    name: "Ouverture - Heure de déclenchement / Trigger time"
    selector:
      time: {}

  open_time_random_minutes:
    name: "Ouverture - Tolérance d’heure (min) / Time tolerance (min)"
    default: 0
    selector:
      number:
        min: 0
        max: 60
        unit_of_measurement: "min"

  open_weekdays:
    name: "Ouverture - Jours d’exécution / Weekdays"
    default:
      - mon
      - tue
      - wed
      - thu
      - fri
    selector:
      select:
        multiple: true
        options:
          - mon
          - tue
          - wed
          - thu
          - fri
          - sat
          - sun

  open_notify_devices:
    name: "Ouverture - Appareils de notification / Notification devices"
    default: []
    selector:
      device:
        multiple: true
        integration: mobile_app

  open_notify_title:
    name: "Ouverture - Titre notification / Notification title"
    default: "Volets – Ouverture"
    selector:
      text: {}

  open_notify_message:
    name: "Ouverture - Message notification (préfixe optionnel)"
    default: ""
    selector:
      text:
        multiline: true

  ############################################################
  # PRE-CLOSE PHASE
  ############################################################
  pre_close_enabled:
    name: "Activer la phase pré-fermeture / Enable pre-close phase"
    default: false
    selector:
      boolean: {}

  pre_close_covers:
    name: "Volets pré-fermeture / Pre-close covers"
    selector:
      entity:
        domain: cover
        multiple: true

  pre_close_use_from:
    name: "Pré-fermeture - Filtrer par position de départ ?"
    default: false
    selector:
      boolean: {}

  pre_close_from:
    name: "Pré-fermeture - From (%) – position de départ"
    default: 100
    selector:
      number:
        min: 0
        max: 100
        unit_of_measurement: "%"

  pre_close_from_tolerance:
    name: "Pré-fermeture - Tolérance from (%)"
    default: 0
    selector:
      number:
        min: 0
        max: 20
        unit_of_measurement: "%"

  pre_close_to:
    name: "Pré-fermeture - To (%) – position cible"
    default: 40
    selector:
      number:
        min: 0
        max: 100
        unit_of_measurement: "%"

  pre_close_use_to_random:
    name: "Pré-fermeture - Randomiser la position cible ?"
    default: false
    selector:
      boolean: {}

  pre_close_to_tolerance:
    name: "Pré-fermeture - Tolérance cible (%)"
    default: 0
    selector:
      number:
        min: 0
        max: 20
        unit_of_measurement: "%"

  pre_close_time:
    name: "Pré-fermeture - Heure de déclenchement / Trigger time"
    selector:
      time: {}

  pre_close_time_random_minutes:
    name: "Pré-fermeture - Tolérance d’heure (min) / Time tolerance (min)"
    default: 0
    selector:
      number:
        min: 0
        max: 60
        unit_of_measurement: "min"

  pre_close_weekdays:
    name: "Pré-fermeture - Jours d’exécution / Weekdays"
    default:
      - mon
      - tue
      - wed
      - thu
      - fri
    selector:
      select:
        multiple: true
        options:
          - mon
          - tue
          - wed
          - thu
          - fri
          - sat
          - sun

  pre_close_notify_devices:
    name: "Pré-fermeture - Appareils de notification / Notification devices"
    default: []
    selector:
      device:
        multiple: true
        integration: mobile_app

  pre_close_notify_title:
    name: "Pré-fermeture - Titre notification / Notification title"
    default: "Volets – Pré-fermeture"
    selector:
      text: {}

  pre_close_notify_message:
    name: "Pré-fermeture - Message notification (préfixe optionnel)"
    default: ""
    selector:
      text:
        multiline: true

  ############################################################
  # CLOSE PHASE
  ############################################################
  close_enabled:
    name: "Activer la phase de fermeture / Enable close phase"
    default: false
    selector:
      boolean: {}

  close_covers:
    name: "Volets fermeture / Close covers"
    selector:
      entity:
        domain: cover
        multiple: true

  close_use_from:
    name: "Fermeture - Filtrer par position de départ ?"
    default: false
    selector:
      boolean: {}

  close_from:
    name: "Fermeture - From (%) – position de départ"
    default: 40
    selector:
      number:
        min: 0
        max: 100
        unit_of_measurement: "%"

  close_from_tolerance:
    name: "Fermeture - Tolérance from (%)"
    default: 0
    selector:
      number:
        min: 0
        max: 20
        unit_of_measurement: "%"

  close_to:
    name: "Fermeture - To (%) – position cible"
    default: 0
    selector:
      number:
        min: 0
        max: 100
        unit_of_measurement: "%"

  close_use_to_random:
    name: "Fermeture - Randomiser la position cible ?"
    default: false
    selector:
      boolean: {}

  close_to_tolerance:
    name: "Fermeture - Tolérance cible (%)"
    default: 0
    selector:
      number:
        min: 0
        max: 20
        unit_of_measurement: "%"

  close_time:
    name: "Fermeture - Heure de déclenchement / Trigger time"
    selector:
      time: {}

  close_time_random_minutes:
    name: "Fermeture - Tolérance d’heure (min) / Time tolerance (min)"
    default: 0
    selector:
      number:
        min: 0
        max: 60
        unit_of_measurement: "min"

  close_weekdays:
    name: "Fermeture - Jours d’exécution / Weekdays"
    default:
      - mon
      - tue
      - wed
      - thu
      - fri
    selector:
      select:
        multiple: true
        options:
          - mon
          - tue
          - wed
          - thu
          - fri
          - sat
          - sun

  close_notify_devices:
    name: "Fermeture - Appareils de notification / Notification devices"
    default: []
    selector:
      device:
        multiple: true
        integration: mobile_app

  close_notify_title:
    name: "Fermeture - Titre notification / Notification title"
    default: "Volets – Fermeture"
    selector:
      text: {}

  close_notify_message:
    name: "Fermeture - Message notification (préfixe optionnel)"
    default: ""
    selector:
      text:
        multiline: true

mode: single

trigger:
  - id: pre_open
    platform: time
    at: !input pre_open_time
  - id: open
    platform: time
    at: !input open_time
  - id: pre_close
    platform: time
    at: !input pre_close_time
  - id: close
    platform: time
    at: !input close_time

action:
  - variables:
      prefix: !input global_phase_prefix
      pre_open_enabled_var: !input pre_open_enabled
      open_enabled_var: !input open_enabled
      pre_close_enabled_var: !input pre_close_enabled
      close_enabled_var: !input close_enabled

  - choose:

      ############################################################
      # PRE-OPEN
      ############################################################
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'pre_open' and pre_open_enabled_var }}"
        sequence:
          - condition: time
            weekday: !input pre_open_weekdays

          - delay:
              minutes: >
                {{ range(0, (!input pre_open_time_random_minutes | int(0)) + 1) | random }}

          - variables:
              phase_name: "Pré-ouverture / Pre-open"
              phase_covers: !input pre_open_covers
              use_from: !input pre_open_use_from
              from_pos: !input pre_open_from
              from_tol: !input pre_open_from_tolerance
              to_pos_base: !input pre_open_to
              to_tol: !input pre_open_to_tolerance
              use_to_random: !input pre_open_use_to_random
              user_prefix_msg: !input pre_open_notify_message

              to_pos_final: >
                {% set base = to_pos_base | int(0) %}
                {% if use_to_random %}
                  {% set tol = to_tol | int(0) %}
                  {% set low = [0, base - tol] | max %}
                  {% set high = [100, base + tol] | min %}
                  {{ range(low, high + 1) | random }}
                {% else %}
                  {{ base }}
                {% endif %}

              moved_covers: >
                {% if not use_from %}
                  {{ phase_covers }}
                {% else %}
                  {% set f = from_pos | int(0) %}
                  {% set t = from_tol | int(0) %}
                  {% set min_pos = [0, f - t] | max %}
                  {% set max_pos = [100, f + t] | min %}
                  {{
                    expand(phase_covers)
                    | selectattr('attributes.current_position','defined')
                    | selectattr('attributes.current_position','>=', min_pos)
                    | selectattr('attributes.current_position','<=', max_pos)
                    | map(attribute='entity_id')
                    | list
                  }}
                {% endif %}

              not_moved_positions: >
                {% set moved = moved_covers %}
                {% set ns = namespace(out={}) %}
                {% for c in expand(phase_covers)
                     | rejectattr('entity_id','in', moved) %}
                  {% set ns.out = ns.out
                     | combine({ c.entity_id: c.attributes.current_position | default('n/a') }) %}
                {% endfor %}
                {{ ns.out }}

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ moved_covers | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ moved_covers }}"
                      sequence:
                        - service: cover.set_cover_position
                          data:
                            position: "{{ to_pos_final }}"
                          target:
                            entity_id: "{{ repeat.item }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ (!input pre_open_notify_devices) | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: !input pre_open_notify_devices
                      sequence:
                        - device_id: "{{ repeat.item }}"
                          domain: mobile_app
                          type: notify
                          title: !input pre_open_notify_title
                          message: >
                            {%- if user_prefix_msg %}
                            {{ user_prefix_msg }}

                            {%- endif %}
                            [{{ prefix }}] Phase {{ phase_name }} → {{ to_pos_final }}%.
                            Volets ayant bougé:
                            {%- if moved_covers | length == 0 %}
                              (aucun)
                            {%- else %}
                              {% for c in moved_covers %}
                                - {{ c }}
                              {% endfor %}
                            {%- endif %}

                            Volets n'ayant pas bougé:
                            {%- if not_moved_positions | length == 0 %}
                              (aucun)
                            {%- else %}
                              {% for c, pos in not_moved_positions.items() %}
                                - {{ c }} : {{ pos }}%
                              {% endfor %}
                            {%- endif %}

      ############################################################
      # OPEN
      ############################################################
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'open' and open_enabled_var }}"
        sequence:
          - condition: time
            weekday: !input open_weekdays

          - delay:
              minutes: >
                {{ range(0, (!input open_time_random_minutes | int(0)) + 1) | random }}

          - variables:
              phase_name: "Ouverture / Open"
              phase_covers: !input open_covers
              use_from: !input open_use_from
              from_pos: !input open_from
              from_tol: !input open_from_tolerance
              to_pos_base: !input open_to
              to_tol: !input open_to_tolerance
              use_to_random: !input open_use_to_random
              user_prefix_msg: !input open_notify_message

              to_pos_final: >
                {% set base = to_pos_base | int(0) %}
                {% if use_to_random %}
                  {% set tol = to_tol | int(0) %}
                  {% set low = [0, base - tol] | max %}
                  {% set high = [100, base + tol] | min %}
                  {{ range(low, high + 1) | random }}
                {% else %}
                  {{ base }}
                {% endif %}

              moved_covers: >
                {% if not use_from %}
                  {{ phase_covers }}
                {% else %}
                  {% set f = from_pos | int(0) %}
                  {% set t = from_tol | int(0) %}
                  {% set min_pos = [0, f - t] | max %}
                  {% set max_pos = [100, f + t] | min %}
                  {{
                    expand(phase_covers)
                    | selectattr('attributes.current_position','defined')
                    | selectattr('attributes.current_position','>=', min_pos)
                    | selectattr('attributes.current_position','<=', max_pos)
                    | map(attribute='entity_id')
                    | list
                  }}
                {% endif %}

              not_moved_positions: >
                {% set moved = moved_covers %}
                {% set ns = namespace(out={}) %}
                {% for c in expand(phase_covers)
                     | rejectattr('entity_id','in', moved) %}
                  {% set ns.out = ns.out
                     | combine({ c.entity_id: c.attributes.current_position | default('n/a') }) %}
                {% endfor %}
                {{ ns.out }}

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ moved_covers | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ moved_covers }}"
                      sequence:
                        - service: cover.set_cover_position
                          data:
                            position: "{{ to_pos_final }}"
                          target:
                            entity_id: "{{ repeat.item }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ (!input open_notify_devices) | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: !input open_notify_devices
                      sequence:
                        - device_id: "{{ repeat.item }}"
                          domain: mobile_app
                          type: notify
                          title: !input open_notify_title
                          message: >
                            {%- if user_prefix_msg %}
                            {{ user_prefix_msg }}

                            {%- endif %}
                            [{{ prefix }}] Phase {{ phase_name }} → {{ to_pos_final }}%.
                            Volets ayant bougé:
                            {%- if moved_covers | length == 0 %}
                              (aucun)
                            {%- else %}
                              {% for c in moved_covers %}
                                - {{ c }}
                              {% endfor %}
                            {%- endif %}

                            Volets n'ayant pas bougé:
                            {%- if not_moved_positions | length == 0 %}
                              (aucun)
                            {%- else %}
                              {% for c, pos in not_moved_positions.items() %}
                                - {{ c }} : {{ pos }}%
                              {% endfor %}
                            {%- endif %}

      ############################################################
      # PRE-CLOSE
      ############################################################
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'pre_close' and pre_close_enabled_var }}"
        sequence:
          - condition: time
            weekday: !input pre_close_weekdays

          - delay:
              minutes: >
                {{ range(0, (!input pre_close_time_random_minutes | int(0)) + 1) | random }}

          - variables:
              phase_name: "Pré-fermeture / Pre-close"
              phase_covers: !input pre_close_covers
              use_from: !input pre_close_use_from
              from_pos: !input pre_close_from
              from_tol: !input pre_close_from_tolerance
              to_pos_base: !input pre_close_to
              to_tol: !input pre_close_to_tolerance
              use_to_random: !input pre_close_use_to_random
              user_prefix_msg: !input pre_close_notify_message

                            to_pos_final: >
                {% set base = to_pos_base | int(0) %}
                {% if use_to_random %}
                  {% set tol = to_tol | int(0) %}
                  {% set low = [0, base - tol] | max %}
                  {% set high = [100, base + tol] | min %}
                  {{ range(low, high + 1) | random }}
                {% else %}
                  {{ base }}
                {% endif %}

              moved_covers: >
                {% if not use_from %}
                  {{ phase_covers }}
                {% else %}
                  {% set f = from_pos | int(0) %}
                  {% set t = from_tol | int(0) %}
                  {% set min_pos = [0, f - t] | max %}
                  {% set max_pos = [100, f + t] | min %}
                  {{
                    expand(phase_covers)
                    | selectattr('attributes.current_position','defined')
                    | selectattr('attributes.current_position','>=', min_pos)
                    | selectattr('attributes.current_position','<=', max_pos)
                    | map(attribute='entity_id')
                    | list
                  }}
                {% endif %}

              not_moved_positions: >
                {% set moved = moved_covers %}
                {% set ns = namespace(out={}) %}
                {% for c in expand(phase_covers)
                     | rejectattr('entity_id','in', moved) %}
                  {% set ns.out = ns.out
                     | combine({ c.entity_id: c.attributes.current_position | default('n/a') }) %}
                {% endfor %}
                {{ ns.out }}

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ moved_covers | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ moved_covers }}"
                      sequence:
                        - service: cover.set_cover_position
                          data:
                            position: "{{ to_pos_final }}"
                          target:
                            entity_id: "{{ repeat.item }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ (!input pre_close_notify_devices) | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: !input pre_close_notify_devices
                      sequence:
                        - device_id: "{{ repeat.item }}"
                          domain: mobile_app
                          type: notify
                          title: !input pre_close_notify_title
                          message: >
                            {%- if user_prefix_msg %}
                            {{ user_prefix_msg }}

                            {%- endif %}
                            [{{ prefix }}] Phase {{ phase_name }} → {{ to_pos_final }}%.
                            Volets ayant bougé:
                            {%- if moved_covers | length == 0 %}
                              (aucun)
                            {%- else %}
                              {% for c in moved_covers %}
                                - {{ c }}
                              {% endfor %}
                            {%- endif %}

                            Volets n'ayant pas bougé:
                            {%- if not_moved_positions | length == 0 %}
                              (aucun)
                            {%- else %}
                              {% for c, pos in not_moved_positions.items() %}
                                - {{ c }} : {{ pos }}%
                              {% endfor %}
                            {%- endif %}

      ############################################################
      # CLOSE
      ############################################################
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'close' and close_enabled_var }}"
        sequence:
          - condition: time
            weekday: !input close_weekdays

          - delay:
              minutes: >
                {{ range(0, (!input close_time_random_minutes | int(0)) + 1) | random }}

          - variables:
              phase_name: "Fermeture / Close"
              phase_covers: !input close_covers
              use_from: !input close_use_from
              from_pos: !input close_from
              from_tol: !input close_from_tolerance
              to_pos_base: !input close_to
              to_tol: !input close_to_tolerance
              use_to_random: !input close_use_to_random
              user_prefix_msg: !input close_notify_message

              to_pos_final: >
                {% set base = to_pos_base | int(0) %}
                {% if use_to_random %}
                  {% set tol = to_tol | int(0) %}
                  {% set low = [0, base - tol] | max %}
                  {% set high = [100, base + tol] | min %}
                  {{ range(low, high + 1) | random }}
                {% else %}
                  {{ base }}
                {% endif %}

              moved_covers: >
                {% if not use_from %}
                  {{ phase_covers }}
                {% else %}
                  {% set f = from_pos | int(0) %}
                  {% set t = from_tol | int(0) %}
                  {% set min_pos = [0, f - t] | max %}
                  {% set max_pos = [100, f + t] | min %}
                  {{
                    expand(phase_covers)
                    | selectattr('attributes.current_position','defined')
                    | selectattr('attributes.current_position','>=', min_pos)
                    | selectattr('attributes.current_position','<=', max_pos)
                    | map(attribute='entity_id')
                    | list
                  }}
                {% endif %}

              not_moved_positions: >
                {% set moved = moved_covers %}
                {% set ns = namespace(out={}) %}
                {% for c in expand(phase_covers)
                     | rejectattr('entity_id','in', moved) %}
                  {% set ns.out = ns.out
                     | combine({ c.entity_id: c.attributes.current_position | default('n/a') }) %}
                {% endfor %}
                {{ ns.out }}

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ moved_covers | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: "{{ moved_covers }}"
                      sequence:
                        - service: cover.set_cover_position
                          data:
                            position: "{{ to_pos_final }}"
                          target:
                            entity_id: "{{ repeat.item }}"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ (!input close_notify_devices) | length > 0 }}"
                sequence:
                  - repeat:
                      for_each: !input close_notify_devices
                      sequence:
                        - device_id: "{{ repeat.item }}"
                          domain: mobile_app
                          type: notify
                          title: !input close_notify_title
                          message: >
                            {%- if user_prefix_msg %}
                            {{ user_prefix_msg }}

                            {%- endif %}
                            [{{ prefix }}] Phase {{ phase_name }} → {{ to_pos_final }}%.
                            Volets ayant bougé:
                            {%- if moved_covers | length == 0 %}
                              (aucun)
                            {%- else %}
                              {% for c in moved_covers %}
                                - {{ c }}
                              {% endfor %}
                            {%- endif %}

                            Volets n'ayant pas bougé:
                            {%- if not_moved_positions | length == 0 %}
                              (aucun)
                            {%- else %}
                              {% for c, pos in not_moved_positions.items() %}
                                - {{ c }} : {{ pos }}%
                              {% endfor %}
                            {%- endif %}
